<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Zachary Loeber">
        <meta name="description" content="Zachary Loeber&#39;s Personal Site">
        <meta name="keywords" content="blog,personal,devops,infrastructure,code,cloud,Azure,AWS,Kubernetes,Docker">
        <meta name="generator" content="Hugo 0.59.1" />
        <title> Big-IP: Custom IIS SOAP Monitor | Zachary Loeber</title>
        <meta name="description" content="Big-IP: Custom IIS SOAP Monitor - Zachary Loeber&#39;s Personal Site">
        <meta itemprop="name" content="Big-IP: Custom IIS SOAP Monitor">
        <meta itemprop="description" content="Big-IP: Custom IIS SOAP Monitor - Zachary Loeber&#39;s Personal Site">
        <meta property="og:title" content="Big-IP: Custom IIS SOAP Monitor">
        <meta property="og:description" content="Big-IP: Custom IIS SOAP Monitor - Zachary Loeber&#39;s Personal Site">
        <meta property="og:image" content="https://www.gravatar.com/avatar/48fc6231ab6cad25f101a82e5932d9dd?size=200">
        <meta property="og:url" content="https://zacharyloeber.com/blog/2011/01/22/big-ip-custom-iis-soap-monitor/">
        <meta property="og:site_name" content="Zachary Loeber">
        <meta property="og:type" content="article">
        <link rel="icon" type="image/png" href="https://zacharyloeber.com/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://zacharyloeber.com/favicon-16x16.png" sizes="16x16">

	
	  <link href="/blog/2011/01/22/big-ip-custom-iis-soap-monitor/" rel="alternate" type="application/rss+xml" title="Zachary Loeber" />
	  <link href="/blog/2011/01/22/big-ip-custom-iis-soap-monitor/" rel="feed" type="application/rss+xml" title="Zachary Loeber" />
	

        
        
        
        
        <link rel="stylesheet" href="/sass/combined.min.5f50be91a665634f9dfed5900bc388393fc430e3369d58e73b8375457a6df832.css">

        

        
            
                <link rel="stylesheet" href="https://zacharyloeber.com/css/mermaid.css">
            
        
    </head>
    <body class="bilberry-hugo-theme">
        
<nav class="permanentTopNav">

    <div class="container">
        <ul class="topnav">
            
                
                    <li><a href="/" target="">Home</a></li>
                
            
                
                    <li><a href="https://zacharyloeber.com/page/about/">About</a></li>
                
            
                
                    <li><a href="https://zacharyloeber.com/page/about-me/">About Me</a></li>
                
            
        </ul>

        
    </div>
</nav>


        <header>
    <div class="container">
        <div class="logo">
            <a href="/" class="logo">
                
                    <img src="https://www.gravatar.com/avatar/48fc6231ab6cad25f101a82e5932d9dd?d=mm&size=200" alt="">
                

                <span class="overlay"><i class="fa fa-home"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title"><a href="/">Zachary Loeber</a></h3>
            
                <span class="subtitle">The personal website of Zachary Loeber.</span>
            
        </div>

    

        
        <div class="toggler permanentTopNav">
        
            <i class="fa fa-bars" aria-hidden="true"></i>
        </div>
    </div>
</header>


        <div class="main container">
            
     
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="https://zacharyloeber.com/blog/2011/01/22/big-ip-custom-iis-soap-monitor/">
    <i class="fa fa-fw fa-pencil"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h3><a href="https://zacharyloeber.com/blog/2011/01/22/big-ip-custom-iis-soap-monitor/">Big-IP: Custom IIS SOAP Monitor</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2011-01-22</span>
            
        

        
            <span class="readingTime">3 min read</span>
        

        
            <span class="categories">
                
                    <a href="/categories/big-ip">BIG-IP</a>
                
                    <a href="/categories/iis">IIS</a>
                
                    <a href="/categories/linux">Linux</a>
                
                    <a href="/categories/microsoft">Microsoft</a>
                
                    <a href="/categories/networking">Networking</a>
                
                    <a href="/categories/system-administration">System Administration</a>
                
            </span>
        

        
            <span class="author"><a href="/author/zachary-loeber">Zachary Loeber</a></span>
        
    </div>

    
        <p>In working on a production issue with my company&#8217;s flagship SaaS product I worked with some of the brilliant F5 engineers to isolate one web server in the load balanced pool which was intermittently failing. The F5 engineer recommended a health monitor that does more than just poll for a static page. He suggested we implement some kind of soap call to make the application pool do some work and return a result (I guess in case the IIS application pool is misbehaving but not down). So I worked with one of our developers to do just that but ran into some caveats which required yet another custom health monitor.</p>

<p>Their default soap health monitor did not work as advertised on our load balancers. We discovered through some tcpdumps that the default Big-IP monitor sends a &#8220;SoapAction&#8221; header in the request but with no value and by default the SOAP call in IIS does not support this I guess. Rather than push for an effort to fix the web configs to handle empty requests I just hacked together a quick custom health monitor to send the header request in a way that the IIS configuration could handle. There are two parts to this monitor, the monitor itself and an xml file with the actual request to send.  I cannot help you with the actual SOAP method creation on your IIS server though, connect with your devs for that. I didn&#8217;t use the cool F5 script template like I did with the last monitor but this is still fully functional (assuming you modify the xml request to your environment/custom soap page). First the actual monitor:</p>

<pre>#!/bin/bash
# Zachary Loeber 01/21/2011
#
# these arguments supplied automatically for all external monitors:
# $1 = IP (nnn.nnn.nnn.nnn notation or hostname)
# $2 = port (decimal, host byte order)
# $3 = name to be looked up
# $4 = string in expected response
#
# The following variables should be set for this to work properly
# SOAPACTION: the action which is injected into the host header of the request
#               (ie. http://tempuri.org/Status)
# XMLREQUESTFILE: the location of your uploaded XML request (ie. /usr/bin/monitors/myweb.xml)
# URI: Your soap request uri (ie. webservices/f5.asmx)
# SOAPRESPONSE: what you expect in a valid response (ie. OK)

IP=`echo $1 | sed 's/::ffff://'`
pidfile="/var/run/`basename $0`.$IP.$PORT.pid"

if [ -f $pidfile ]
then
 kill -9 `cat $pidfile` &gt; /dev/null 2&gt;&1
fi
echo "$$" &gt; $pidfile

/usr/bin/curl -H 'Content-Type: text/xml; charset=utf-8' -H "SOAPAction: $SOAPACTION" -d @"$XMLREQUESTFILE" -X POST "http://${IP}:${2}/$URI"  | grep -i "$SOAPRESPONSE" 2&gt;&1 &gt; /dev/null

if [ $? -eq 0 ]
then
 echo "UP"
fi

rm -f $pidfile
exit</pre>

<p>Here is a quick example of an xml file you could use, this is based on a quick and dirty custom asmx file that my company&#8217;s devs whipped up that simply returns OK if sent a soap request method called &#8220;Status&#8221;:</p>

<pre>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;
  &lt;soap:Body&gt;
    &lt;Status xmlns="http://tempuri.org/" /&gt;
  &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</pre>

<p>save both files to /usr/bin/monitors/ and chmod +x the customsoap.sh. Then define your custom health monitor to call customsoap.sh. An example is below:</p>

<div id="attachment_249" style="width: 374px" class="wp-caption alignleft">
  <a href="/wp-content/uploads/2011/01/big-ip_custom_soap_monitor.jpg"><img class="size-full wp-image-249" title="big-ip_custom_soap_monitor" src="/wp-content/uploads/2011/01/big-ip_custom_soap_monitor.jpg?resize=364%2C552" alt="Custom Soap Monitor Example Configuration" width="364" height="552" data-recalc-dims="1" /></a>
  
  <p class="wp-caption-text">
    Custom Soap Monitor Example Configuration
  </p>
</div>
    
</div>

    
<div class="footer no-tags">


    

    
</div>

</article>

        
    </div>

    
        
    

     

        </div>

        
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong>Latest posts</strong>
                <ul>
                
                    <li>
                        <a href="https://zacharyloeber.com/blog/2019/12/8/hugo-a-devops-approach/">Hugo - A DevOps Approach</a>
                    </li>
                
                    <li>
                        <a href="https://zacharyloeber.com/blog/2018/12/10/devops-tool-of-the-day-syncthing/">Devops: Tool of the day – Syncthing</a>
                    </li>
                
                    <li>
                        <a href="https://zacharyloeber.com/blog/2018/09/28/devops-automating-kubernetes-deployments/">DevOps – Automating Kubernetes Deployments</a>
                    </li>
                
                </ul>
        </div>
        

        
        <div class="categories">
            <a href="/categories/"><strong>Categories</strong></a>
                <ul>
                
                    <li>
                        <a href="/categories/system-administration">System administration (130)</a>
                    </li>
                
                    <li>
                        <a href="/categories/microsoft">Microsoft (120)</a>
                    </li>
                
                    <li>
                        <a href="/categories/powershell">Powershell (106)</a>
                    </li>
                
                    <li>
                        <a href="/categories/networking">Networking (52)</a>
                    </li>
                
                    <li>
                        <a href="/categories/active-directory">Active directory (44)</a>
                    </li>
                
            </ul>
        </div>
        

        <div class="right">
            
            <div class="external-profiles">
                <strong>Social media</strong>

                
                
                    <a href="https://twitter.com/zloeber" target="_blank"><i class="fa fa-twitter-adblock-proof"></i></a>
                
                
                
                
                
                
                
                
                
                    <a href="https://github.com/zloeber" target="_blank"><i class="fa fa-github"></i></a>
                
                
                    <a href="https://www.linkedin.com/in/zloeber/" target="_blank"><i class="fa fa-linkedin"></i></a>
                
            </div>
            

            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://github.com/zloeber" target="_blank">
                &copy;
                
                    2019
                
                by Zachary Loeber
            </a>
	    
        </div>
        <div class="author">
            <a href="https://github.com/Lednerb/bilberry-hugo-theme" target="_blank">Bilberry Hugo Theme</a>
        </div>
    </div>
</div>


        

        

        
        
        <script type="text/javascript" src="/js/externalDependencies.39c47e10e241eae2947b3fe21809c572.js" integrity="md5-OcR&#43;EOJB6uKUez/iGAnFcg=="></script>

        
        
        <script type="text/javascript" src="/js/theme.ff50ae6dc1bfc220b23bf69dbb41b54e.js" integrity="md5-/1CubcG/wiCyO/adu0G1Tg=="></script>

        <script>
            $(".moment").each(function() {
                $(this).text(
                    moment( $(this).text() )
                        .locale( "en" )
                        .format('LL')
                );
            });

            $(".footnote-return sup").html("");
        </script>

        
            
                <script src="https://zacharyloeber.com/js/mermaid.js" type="application/javascript"></script>
            
        

        


    </body>
</html>
