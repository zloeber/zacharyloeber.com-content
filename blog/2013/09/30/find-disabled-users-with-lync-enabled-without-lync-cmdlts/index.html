<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta name=description content><meta name=keywords content><meta name=generator content="Hugo 0.53"><title>Find Disabled Users With Lync Enabled Without Lync Cmdlts |</title><meta name=description content="Find Disabled Users With Lync Enabled Without Lync Cmdlts - %!s(&lt;nil&gt;)"><meta itemprop=name content="Find Disabled Users With Lync Enabled Without Lync Cmdlts"><meta itemprop=description content="Find Disabled Users With Lync Enabled Without Lync Cmdlts - %!s(&lt;nil&gt;)"><meta property=og:title content="Find Disabled Users With Lync Enabled Without Lync Cmdlts"><meta property=og:description content="Find Disabled Users With Lync Enabled Without Lync Cmdlts - %!s(&lt;nil&gt;)"><meta property=og:image content="https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?size=200"><meta property=og:url content=https://zacharyloeber.com/blog/2013/09/30/find-disabled-users-with-lync-enabled-without-lync-cmdlts/><meta property=og:site_name content><meta property=og:type content=article><link rel=icon type=image/png href=https://zacharyloeber.com/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://zacharyloeber.com/favicon-16x16.png sizes=16x16><link rel=stylesheet href=/sass/combined.min.5aca3dc995ccd40fd537c60ccb5ce5882145ec5d4c4827c15f277667981cc0de.css></head><body class=bilberry-hugo-theme><nav><div class=container><ul class=topnav><li><a href=https://github.com/zloeber target=_blank>Github</a></li><li><a href=/page/about/>About</a></li><li><a href=/page/about-me/>About Me</a></li></ul></div></nav><header><div class=container><div class=logo><a href=/ class=logo><img src="https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?d=mm&size=200" alt>
<span class=overlay><i class="fa fa-home"></i></span></a></div><div class=titles><h3 class=title><a href=/>My cool new blog</a></h3></div><div class=toggler><i class="fa fa-bars" aria-hidden=true></i></div></div></header><div class="main container"><div class="article-wrapper u-cf single"><a class=bubble href=/blog/2013/09/30/find-disabled-users-with-lync-enabled-without-lync-cmdlts/><i class="fa fa-fw fa-pencil"></i></a><article class="default article"><div class=content><h3><a href=/blog/2013/09/30/find-disabled-users-with-lync-enabled-without-lync-cmdlts/>Find Disabled Users With Lync Enabled Without Lync Cmdlts</a></h3><div class=meta><span class="date moment">2013-09-30</span>
<span class=categories><a href=/categories/active-directory>Active Directory</a>
<a href=/categories/lync>Lync</a>
<a href=/categories/microsoft>Microsoft</a>
<a href=/categories/powershell>Powershell</a></span>
<span class=author><a href=/author/zachary-loeber>Zachary Loeber</a></span></div><p>Here is a quick tip which applies to more than just Lync. I use powershell with .NET ADSI to gather a list of all users which are disabled but still have Lync sip addresses assigned. There are numerous reasons to disable lync on such accounts. One reason would be to make certain that users whom are no longer with the organization get removed from the Lync address list. Another is so these same users can no longer access Lync! (Yes, a disabled AD account may still be authorized to access Lync).</p><p>It is a common misnomer that the Lync administration console is required to access basic Lync information. In all actuality, you need only have a domain user account and a bit of active directory acumen to report upon a whole bunch of Lync related attributes. And you can get even more information from AD about Exchange (See my article <a href="http://www.peters.com/blog/Lists/Posts/Post.aspx?ID=48">comparing the level of AD reliance Lync and Exchange exhibit</a>).</p><p>Here is a small example on getting some of this kind of info. Essentially all we are looking for are accounts in AD with a disabled account but which still have a primary sip address assigned to theÂ msRTCSIP-PrimaryUserAddress attribute.</p><p>Lets start with the disabled user part. An LDAP filter which will find all the disabled accounts is:</p><pre>(objectCategory=person)(objectClass=user)(useraccountcontrol:1.2.840.113556.1.4.803:=2)</pre><p>Ok, so now add in any account whereÂ Â msRTCSIP-PrimaryUserAddress contains any value. Easy peasy&#8230;</p><pre>(msRTCSIP-PrimaryUserAddress=*)</pre><p>So the new LDAP filter becomes:</p><pre>(objectCategory=person)(objectClass=user)(useraccountcontrol:1.2.840.113556.1.4.803:=2)(msRTCSIP-PrimaryUserAddress=*)</pre><p>So with the magic filter at hand, all that is left to do is query AD with it. You actually don&#8217;t even need to do this with powershell. If so inclined, you can simply create a new advanced query in Active Directory Users and Computers:</p><p><a href=wp-content/uploads/2013/09/ldap-aduc-filter.jpg><img class="aligncenter size-medium wp-image-963" alt=ldap-aduc-filter src="/wp-content/uploads/2013/09/ldap-aduc-filter.jpg?resize=300%2C270" width=300 height=270 srcset="/wp-content/uploads/2013/09/ldap-aduc-filter.jpg?resize=300%2C270 300w, wp-content/uploads/2013/09/ldap-aduc-filter.jpg?w=398 398w" sizes="(max-width: 300px) 100vw, 300px" data-recalc-dims=1></a></p><p>This should instantly show you all your disabled accounts which are still associated with a primary sip address in ADUC. But I promised a powershell way to do this as well. Here it is, without any AD or Lync modules.</p><pre>$ADS_UF_ACCOUNTDISABLE = 0x00002
$root = [ADSI]''
$search = [adsisearcher]$root
$search.PageSize = 2000
$search.Filter = '(&(&(&(objectCategory=person)(objectClass=user)(useraccountcontrol:1.2.840.113556.1.4.803:=2)(msRTCSIP-PrimaryUserAddress=*))))'
$colResults = $Search.FindAll()
$Output = @()
foreach ($i in $colResults)
{
 $ObjProps = @{
 Name = [string]$i.Properties.Item('Name')
 Disabled = [bool]([string]$i.Properties.Item('useraccountcontrol') -band $ADS_UF_ACCOUNTDISABLE)
 PrimarySipAddress = [string]$i.Properties.Item('msRTCSIP-PrimaryUserAddress')
 }
 $Output += New-Object psobject -Property $ObjProps
}</pre><pre>$Output</pre><p>I added in a few items just for aesthetics (The actual sip address and proof that the account is in fact disabled) but it is easy to get the gist of what I&#8217;m doing here. Note that [ADSI]&#8221; is essentially the root of the default naming context, also known as the top of your domain. You can target other partitions to get other information though. Of particular interest is the configuration partition. You can quickly start querying the configuration partition with the following code:</p><pre>$RootDSC = [adsi]"LDAP://RootDSE"
$ConfigNamingContext = $RootDSC.configurationNamingContext
$Root = [ADSI]"LDAP://$([string]$ConfigNamingContext)"</pre><p>If you search the configuration partition for the following:</p><pre>(&(objectClass=msRTCSIP-Pool))</pre><p>And then return theÂ dnshostname attribute, you will have effectively queried AD for all Lync pool names.</p><p>Or filter for internal lync server names:</p><pre>Filter: (&(objectClass=msRTCSIP-TrustedServer))</pre><pre>Attribute:Â msrtcsip-trustedserverfqdn</pre><p>Or find the Lync edge servers&#8230;</p><pre>Filter:Â (&(objectClass=msRTCSIP-EdgeProxy))</pre><pre>Attribute:Â msrtcsip-edgeproxyfqdn</pre><p>Well, you get the picture. AD is a very big open book for those who know where to look ðŸ™‚</p><p>&nbsp;</p><p>&nbsp;</p></div><div class=footer><div class=tags><i class="fa fa-tags"></i><div class=links><a href=/tags/active-directory>Active Directory</a>
<a href=/tags/exchange-2010>Exchange 2010</a>
<a href=/tags/lync>Lync</a>
<a href=/tags/microsoft>Microsoft</a>
<a href=/tags/network-administration>network administration</a>
<a href=/tags/powershell>Powershell</a>
<a href=/tags/scripting>Scripting</a>
<a href=/tags/windows>Windows</a></div></div></div></article></div><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"zacharyloeber-com"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><footer><div class=container><div class=recent-posts><strong>Latest posts</strong><ul><li><a href=/blog/2018/12/10/devops-tool-of-the-day-syncthing/>Devops: Tool of the day â€“ Syncthing</a></li><li><a href=/blog/2018/09/28/devops-automating-kubernetes-deployments/>DevOps â€“ Automating Kubernetes Deployments</a></li><li><a href=/blog/2018/05/02/powershell-to-python-notes-from-the-field/>Powershell To Python Notes From The Field</a></li><li><a href=/blog/2018/03/26/powershell-windows-subsystem-for-linux/>PowerShell: Windows Subsystem For Linux</a></li><li><a href=/blog/2018/02/24/email-reputation-and-design-a-condensed-guide/>Email Reputation and Design: A Condensed Guide</a></li><li><a href=/blog/2018/02/04/powershell-azuread-dynamic-groups/>PowerShell: AzureAD Dynamic Groups</a></li><li><a href=/blog/2018/01/10/powershell-office-365-group-based-licencing-cleanup/>PowerShell: Office 365 Group Based Licencing Cleanup</a></li></ul></div><div class=categories><a href=/categories/><strong>Categories</strong></a><ul><li><a href=/categories/system-administration>System administration (130)</a></li><li><a href=/categories/microsoft>Microsoft (120)</a></li><li><a href=/categories/powershell>Powershell (106)</a></li><li><a href=/categories/networking>Networking (52)</a></li><li><a href=/categories/active-directory>Active directory (44)</a></li><li><a href=/categories/exchange>Exchange (38)</a></li><li><a href=/categories/exchange-2010>Exchange 2010 (38)</a></li></ul></div><div class=right><div class=external-profiles><strong>Social media</strong></div></div></div></footer><div class=credits><div class=container><div class=copyright><a href=https://github.com/Lednerb target=_blank>&copy;
2018
by Lednerb</a></div><div class=author><a href=https://github.com/Lednerb/bilberry-hugo-theme target=_blank>Bilberry Hugo Theme</a></div></div></div><script type=text/javascript src=/js/externalDependencies.39c47e10e241eae2947b3fe21809c572.js integrity="md5-OcR&#43;EOJB6uKUez/iGAnFcg=="></script><script type=text/javascript src=/js/theme.ff50ae6dc1bfc220b23bf69dbb41b54e.js integrity="md5-/1CubcG/wiCyO/adu0G1Tg=="></script><script>$(".moment").each(function(){$(this).text(moment($(this).text()).locale("en").format('LL'));});$(".footnote-return sup").html("");</script></body></html>