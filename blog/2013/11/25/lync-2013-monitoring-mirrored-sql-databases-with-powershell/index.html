<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Zachary Loeber">
        <meta name="description" content="Zachary Loeber&#39;s Personal Site">
        <meta name="keywords" content="blog,personal,devops,infrastructure,code">
        <meta name="generator" content="Hugo 0.53" />
        <title> Lync 2013: Monitoring Mirrored SQL Databases With PowerShell | Zachary Loeber</title>
        <meta name="description" content="Lync 2013: Monitoring Mirrored SQL Databases With PowerShell - Zachary Loeber&#39;s Personal Site">
        <meta itemprop="name" content="Lync 2013: Monitoring Mirrored SQL Databases With PowerShell">
        <meta itemprop="description" content="Lync 2013: Monitoring Mirrored SQL Databases With PowerShell - Zachary Loeber&#39;s Personal Site">
        <meta property="og:title" content="Lync 2013: Monitoring Mirrored SQL Databases With PowerShell">
        <meta property="og:description" content="Lync 2013: Monitoring Mirrored SQL Databases With PowerShell - Zachary Loeber&#39;s Personal Site">
        <meta property="og:image" content="https://www.gravatar.com/avatar/48fc6231ab6cad25f101a82e5932d9dd?size=200">
        <meta property="og:url" content="https://zacharyloeber.com/blog/2013/11/25/lync-2013-monitoring-mirrored-sql-databases-with-powershell/">
        <meta property="og:site_name" content="Zachary Loeber">
        <meta property="og:type" content="article">
        <link rel="icon" type="image/png" href="https://zacharyloeber.com/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://zacharyloeber.com/favicon-16x16.png" sizes="16x16">

	

        
        
        
        
        <link rel="stylesheet" href="https://zacharyloeber.com/sass/combined.min.5f50be91a665634f9dfed5900bc388393fc430e3369d58e73b8375457a6df832.css">

        

        
            
        
    </head>
    <body class="bilberry-hugo-theme">
        
<nav class="permanentTopNav">

    <div class="container">
        <ul class="topnav">
            
                
                    <li><a href="https://zacharyloeber.com/" target="">Home</a></li>
                
            
                
                    <li><a href="https://zacharyloeber.com/page/about/">About</a></li>
                
            
                
                    <li><a href="https://zacharyloeber.com/page/about-me/">About Me</a></li>
                
            
                
                    <li><a href="https://github.com/zloeber" target="_blank">Github</a></li>
                
            
        </ul>

        
    </div>
</nav>


        <header>
    <div class="container">
        <div class="logo">
            <a href="https://zacharyloeber.com/" class="logo">
                
                    <img src="https://www.gravatar.com/avatar/48fc6231ab6cad25f101a82e5932d9dd?d=mm&size=200" alt="">
                

                <span class="overlay"><i class="fa fa-home"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title"><a href="https://zacharyloeber.com/">Zachary Loeber</a></h3>
            
                <span class="subtitle">The personal website of Zachary Loeber.</span>
            
        </div>

    

        
        <div class="toggler permanentTopNav">
        
            <i class="fa fa-bars" aria-hidden="true"></i>
        </div>
    </div>
</header>


        <div class="main container">
            
     
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="https://zacharyloeber.com/blog/2013/11/25/lync-2013-monitoring-mirrored-sql-databases-with-powershell/">
    <i class="fa fa-fw fa-pencil"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h3><a href="https://zacharyloeber.com/blog/2013/11/25/lync-2013-monitoring-mirrored-sql-databases-with-powershell/">Lync 2013: Monitoring Mirrored SQL Databases With PowerShell</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2013-11-25</span>
            
        

        
            <span class="readingTime">5 min read</span>
        

        
            <span class="categories">
                
                    <a href="https://zacharyloeber.com/categories/lync">Lync</a>
                
                    <a href="https://zacharyloeber.com/categories/microsoft">Microsoft</a>
                
                    <a href="https://zacharyloeber.com/categories/powershell">Powershell</a>
                
                    <a href="https://zacharyloeber.com/categories/system-administration">System Administration</a>
                
            </span>
        

        
            <span class="author"><a href="https://zacharyloeber.com/author/zachary-loeber">Zachary Loeber</a></span>
        
    </div>

    
        <p>In Lync 2013 you are given a powerful new backend redundancy option for your important databases in the form of SQL mirroring. In this article I’ll discuss which services are able to be mirrored, the databases they encompass, and provide a PowerShell script to generate a report on the database mirror status. I also threw in Lync CMS replication and service status sections because it is the civil thing to do&#8230;</p>

<hr />

<p>In picking through the backend changes between Lync 2010 and 2013 I found myself looking quite a bit more deeply into the new SQL mirroring support than I originally intended. The quick rundown of Lync database mirroring is that there are several Lync service types that are able to be setup for SQL mirroring. These services, in turn, consist of one or more databases which are actually mirrored between two sql servers. You can look at the status of your backend SQL database mirrors within the SQL management tool. Or you can also look at the status within the Lync server control panel by going to Topology -&gt; Status, then selecting the properties of a server.</p>

<p>Unfortunately, there is a slight disconnect between the individual databases which are mirrored, the services that they map to, and the actual database servers which the primary (aka. principal) and mirrored databases reside. The services that a particular database map to is important to know as that is how database fail overs are manually managed within Lync (using Invoke-CsDatabaseFailover -PoolFqdn &lt;<em>pool.domain.com&gt;</em> -DatabaseType <em><Type></em>).</p>

<p>As multiple databases can map to a single database type, it is also entirely possible to unknowingly be in a state where some databases are failed over to the mirror copy while others are still on the primary copy. A<a href="http://www.mylynclab.com/2013/05/lync-2013-database-mirror-manager-tool.html"> great blog post by James Cussen</a> has a list of Lync 2013 databases and their associated service types (aka. Database Types). He also covers the above mentioned SQL mirroring scenario quite well and provides an excellent GUI script for managing them</p>

<p>Partly driven by James&#8217;s contribution to the community and partly from frustration because of the lack of built in powershell cmdlet functionality, I’ve created a PowerShell function to better report on the lync pools, services, their database mirror state, and associated SQL servers. I then use this information to create a health report based on the state of the primary and mirror databases.</p>

<p>The actual function is quite simple. First we gather a list of Lync pools which are not on the edge and which require replication. This should get me all lync front-end/chat servers. Using these pool Fqdns I loop through and get the results of Get-CsDatabaseMirrorState. For each pool which returns any results I use a hash table of all the database names and their associated service to determine which command I’ll be running to get the primary and mirror database server information from (I could have just integrated this database name checking into the switch statement directly but this should be a more forward moving solution). I have to do this as, for whatever reason, Lync stores all the database server primary/mirror information with different property names in the Get-CSService output. This effectively gives me all the database mirror information and the pool, service, and associated SQL servers.</p>

<p>Here is the function:</p>

<pre>Function Get-LyncDatabaseMirror
{
 Begin
 {</pre>

<pre>$pools = @()
 $dbServices = @{
 'rgsconfig' = 'Application'
 'rgsdyn' = 'Application'
 'cpsdyn' = 'Application'
 'lcslog' = 'Archiving'
 'xds' = 'CentralMgmt'
 'lis' = 'CentralMgmt'
 'mgc' = 'PersistentChat'
 'mgccomp' = 'PersistentChatCompliance'
 'rtcab' = 'UserServer'
 'rtcxds' = 'UserServer'
 'rtcshared' = 'UserServer'
 'lcscdr' = 'Monitoring'
 'qoemetrics' = 'Monitoring'
 }
 $dbs = @()
 $pools = @()
 }
 Process
 {}
 End
 {
 $pools = ((Get-CsTopology).Clusters | 
 Where {($_.RequiresReplication) -and (!$_.IsOnEdge)} | 
 %{[string]$_.Fqdn})
 Foreach ($pool in $pools)
 {
 $dbstates = Get-CsDatabaseMirrorState -PoolFqdn $pool
 if ($dbstates -ne $null)
 {
 foreach ($dbstate in $dbstates)
 {
 switch ($dbServices[[string]$dbstate.DatabaseName]) {
 'Application' {
 Get-CsService -PoolFqdn $pool -ApplicationServer | %{
 $PrimaryDBServer = (([string]$_.ApplicationDatabase).Split(':'))[1]
 $MirrorDBServer = (([string]$_.MirrorApplicationDatabase).Split(':'))[1]
 }
 }
 'Archiving' {
 Get-CsService -PoolFqdn $pool -Registrar | %{
 $PrimaryDBServer = (([string]$_.ArchivingDatabase).Split(':'))[1]
 $MirrorDBServer = (([string]$_.MirrorArchivingDatabase).Split(':'))[1]
 }
 }
 'Monitoring' {
 Get-CsService -PoolFqdn $pool -Registrar | %{
 $PrimaryDBServer = (([string]$_.MonitoringDatabase).Split(':'))[1]
 $MirrorDBServer = (([string]$_.MirrorMonitoringDatabase).Split(':'))[1]
 }
 }
 'CentralMgmt' {
 Get-CsService -PoolFqdn $pool -CentralManagement | %{
 $PrimaryDBServer = (([string]$_.CentralManagementDatabase).Split(':'))[1]
 $MirrorDBServer = (([string]$_.MirrorCentralManagementDatabase).Split(':'))[1]
 }
 }
 'PersistentChat' {
 Get-CsService -PoolFqdn $pool -PersistentChatServer | %{
 $PrimaryDBServer = (([string]$_.PersistentChatDatabase).Split(':'))[1]
 $MirrorDBServer = (([string]$_.MirrorPersistentChatDatabase).Split(':'))[1]
 }
 }
 'PersistentChatCompliance' {
 Get-CsService -PoolFqdn $pool -PersistentChatServer | %{
 $PrimaryDBServer = (([string]$_.PersistentChatComplianceDatabase).Split(':'))[1]
 $MirrorDBServer = (([string]$_.MirrorPersistentChatComplianceDatabase).Split(':'))[1]
 }
 }
 'UserServer' {
 Get-CsService -PoolFqdn $pool -UserServer | %{
 $PrimaryDBServer = (([string]$_.UserDatabase).Split(':'))[1]
 $MirrorDBServer = (([string]$_.MirrorUserDatabase).Split(':'))[1]
 }
 }
 default {
 $PrimaryDBServer = ''
 $MirrorDBServer = ''
 }
 }
 $dbprops = @{
 'Pool' = $pool
 'Application' = $dbServices[[string]$dbstate.DatabaseName]
 'Database' = $dbstate.DatabaseName
 'PrimaryState' = $dbstate.StateOnPrimary
 'MirrorState' = $dbstate.StateOnMirror
 'PrimaryDBServer' = $PrimaryDBServer
 'MirrorDBServer' = $MirrorDBServer
 }
 New-Object psobject -Property $dbprops
 }
 }
 }
 }
}</pre>

<p>I’ve used this function along with a couple others I concocted to create a small Lync 2013 health report for your convenience that you can <a href="http://gallery.technet.microsoft.com/Lync-2013-Mirrored-SQL-132c2f06">download from the Microsoft Technet Gallery.</a> Here is a small part of the output (not shown are the associated pools and sql servers to the left and right):</p>

<div id="attachment_1028" style="width: 238px" class="wp-caption aligncenter">
  <a href="https://zacharyloeber.com/wp-content/uploads/2013/11/Untitled.png"><img class="size-medium wp-image-1028" alt="Lync 2013 Mirrored Database Status" src="https://zacharyloeber.com/wp-content/uploads/2013/11/Untitled.png?resize=228%2C300" width="228" height="300" srcset="https://zacharyloeber.com/wp-content/uploads/2013/11/Untitled.png?resize=228%2C300 228w, wp-content/uploads/2013/11/Untitled.png?w=400 400w" sizes="(max-width: 228px) 100vw, 228px" data-recalc-dims="1" /></a>
  
  <p class="wp-caption-text">
    Lync 2013 Mirrored Database Status
  </p>
</div>
    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="https://zacharyloeber.com/tags/lync">Lync</a>
                
                    <a href="https://zacharyloeber.com/tags/lync-2013">Lync 2013</a>
                
                    <a href="https://zacharyloeber.com/tags/microsoft">Microsoft</a>
                
                    <a href="https://zacharyloeber.com/tags/monitoring">Monitoring</a>
                
                    <a href="https://zacharyloeber.com/tags/powershell">Powershell</a>
                
                    <a href="https://zacharyloeber.com/tags/scripting">Scripting</a>
                
                    <a href="https://zacharyloeber.com/tags/system-administration">System Administration</a>
                
                    <a href="https://zacharyloeber.com/tags/windows">Windows</a>
                
            </div>
        </div>
    

    
</div>

</article>

        
    </div>

    
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "zacharyloeber-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

     

        </div>

        
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong>Latest posts</strong>
                <ul>
                
                    <li>
                        <a href="https://zacharyloeber.com/blog/2018/12/10/devops-tool-of-the-day-syncthing/">Devops: Tool of the day – Syncthing</a>
                    </li>
                
                    <li>
                        <a href="https://zacharyloeber.com/blog/2018/09/28/devops-automating-kubernetes-deployments/">DevOps – Automating Kubernetes Deployments</a>
                    </li>
                
                    <li>
                        <a href="https://zacharyloeber.com/blog/2018/05/02/powershell-to-python-notes-from-the-field/">Powershell To Python Notes From The Field</a>
                    </li>
                
                </ul>
        </div>
        

        
        <div class="categories">
            <a href="https://zacharyloeber.com/categories/"><strong>Categories</strong></a>
                <ul>
                
                    <li>
                        <a href="https://zacharyloeber.com/categories/system-administration">System administration (130)</a>
                    </li>
                
                    <li>
                        <a href="https://zacharyloeber.com/categories/microsoft">Microsoft (120)</a>
                    </li>
                
                    <li>
                        <a href="https://zacharyloeber.com/categories/powershell">Powershell (106)</a>
                    </li>
                
                    <li>
                        <a href="https://zacharyloeber.com/categories/networking">Networking (52)</a>
                    </li>
                
                    <li>
                        <a href="https://zacharyloeber.com/categories/active-directory">Active directory (44)</a>
                    </li>
                
            </ul>
        </div>
        

        <div class="right">
            
            <div class="external-profiles">
                <strong>Social media</strong>

                
                
                    <a href="https://twitter.com/zloeber" target="_blank"><i class="fa fa-twitter-adblock-proof"></i></a>
                
                
                
                
                
                
                
                
                
                    <a href="https://github.com/zloeber" target="_blank"><i class="fa fa-github"></i></a>
                
                
            </div>
            

            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://github.com/zloeber" target="_blank">
                &copy;
                
                    2019
                
                by Zachary Loeber
            </a>
	    
        </div>
        <div class="author">
            <a href="https://github.com/Lednerb/bilberry-hugo-theme" target="_blank">Bilberry Hugo Theme</a>
        </div>
    </div>
</div>


        

        

        
        
        <script type="text/javascript" src="https://zacharyloeber.com/js/externalDependencies.39c47e10e241eae2947b3fe21809c572.js" integrity="md5-OcR&#43;EOJB6uKUez/iGAnFcg=="></script>

        
        
        <script type="text/javascript" src="https://zacharyloeber.com/js/theme.ff50ae6dc1bfc220b23bf69dbb41b54e.js" integrity="md5-/1CubcG/wiCyO/adu0G1Tg=="></script>

        <script>
            $(".moment").each(function() {
                $(this).text(
                    moment( $(this).text() )
                        .locale( "en" )
                        .format('LL')
                );
            });

            $(".footnote-return sup").html("");
        </script>

        
            
        

        


    </body>
</html>
