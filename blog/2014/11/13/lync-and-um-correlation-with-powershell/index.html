<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Zachary Loeber">
        <meta name="description" content="Zachary Loeber&#39;s Personal Site">
        <meta name="keywords" content="blog,personal,devops,infrastructure,code">
        <meta name="generator" content="Hugo 0.53" />
        <title> Lync and UM Correlation with Powershell | Zachary Loeber</title>
        <meta name="description" content="Lync and UM Correlation with Powershell - Zachary Loeber&#39;s Personal Site">
        <meta itemprop="name" content="Lync and UM Correlation with Powershell">
        <meta itemprop="description" content="Lync and UM Correlation with Powershell - Zachary Loeber&#39;s Personal Site">
        <meta property="og:title" content="Lync and UM Correlation with Powershell">
        <meta property="og:description" content="Lync and UM Correlation with Powershell - Zachary Loeber&#39;s Personal Site">
        <meta property="og:image" content="https://www.gravatar.com/avatar/48fc6231ab6cad25f101a82e5932d9dd?size=200">
        <meta property="og:url" content="https://zacharyloeber.com/blog/2014/11/13/lync-and-um-correlation-with-powershell/">
        <meta property="og:site_name" content="Zachary Loeber">
        <meta property="og:type" content="article">
        <link rel="icon" type="image/png" href="https://zacharyloeber.com/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://zacharyloeber.com/favicon-16x16.png" sizes="16x16">

	

        
        
        
        
        <link rel="stylesheet" href="/sass/combined.min.5f50be91a665634f9dfed5900bc388393fc430e3369d58e73b8375457a6df832.css">

        

        
            
        
    </head>
    <body class="bilberry-hugo-theme">
        
<nav class="permanentTopNav">

    <div class="container">
        <ul class="topnav">
            
                
                    <li><a href="/" target="">Home</a></li>
                
            
                
                    <li><a href="/page/about/">About</a></li>
                
            
                
                    <li><a href="/page/about-me/">About Me</a></li>
                
            
                
                    <li><a href="https://github.com/zloeber" target="_blank">Github</a></li>
                
            
        </ul>

        
    </div>
</nav>


        <header>
    <div class="container">
        <div class="logo">
            <a href="/" class="logo">
                
                    <img src="https://www.gravatar.com/avatar/48fc6231ab6cad25f101a82e5932d9dd?d=mm&size=200" alt="">
                

                <span class="overlay"><i class="fa fa-home"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title"><a href="/">Zachary Loeber</a></h3>
            
                <span class="subtitle">The personal website of Zachary Loeber.</span>
            
        </div>

    

        
        <div class="toggler permanentTopNav">
        
            <i class="fa fa-bars" aria-hidden="true"></i>
        </div>
    </div>
</header>


        <div class="main container">
            
     
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="/blog/2014/11/13/lync-and-um-correlation-with-powershell/">
    <i class="fa fa-fw fa-pencil"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h3><a href="/blog/2014/11/13/lync-and-um-correlation-with-powershell/">Lync and UM Correlation with Powershell</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2014-11-14</span>
            
        

        
            <span class="readingTime">5 min read</span>
        

        
            <span class="categories">
                
                    <a href="/categories/active-directory">Active Directory</a>
                
                    <a href="/categories/exchange">Exchange</a>
                
                    <a href="/categories/exchange-2010">Exchange 2010</a>
                
                    <a href="/categories/exchange-2013">Exchange 2013</a>
                
                    <a href="/categories/lync">Lync</a>
                
                    <a href="/categories/microsoft">Microsoft</a>
                
                    <a href="/categories/powershell">Powershell</a>
                
                    <a href="/categories/security">Security</a>
                
                    <a href="/categories/system-administration">System Administration</a>
                
            </span>
        

        
            <span class="author"><a href="/author/zachary-loeber">Zachary Loeber</a></span>
        
    </div>

    
        <p>I&#8217;ve been working on an Exchange/Lync voice deployment lately and have found a new level of frustrationÂ for the lack of connectivity between the several voice components involved in turning up such a solution. That being said it is not very difficult to validate your deployment with a bit of Powershell.</p>

<p>There are a few necessary results to gather where I believe it can be easy to &#8216;miss&#8217; configuration steps when turning up or disabling users:</p>

<ul>
<li>You enable a user for enterprise voice but forget to set their pin</li>
<li>You enable a user for enterprise voice but forget to UM enable their mailbox</li>
<li>You disable a previously lync enabled user (enterprise voice enabled or not) and forget to disable them in Lync</li>
<li>You enable a user for lync enterprise voice and um enable their mailbox but use the wrong extension.</li>
</ul>

<p>These are just a few areas which can go awry in your environment either during the initial deployment or simply occur over time.</p>

<p>Here is a pretty simple function which I&#8217;ve put together which gathers info about all lync enabled accounts and contacts in the environment. As I extrapolate the Exchange UM information from AD attributes this function needs only be run on a Lync server or remote session. Here are the important bits broken down for those who are interested. If you just want the function and do not care for my ramblings you can download it either at the <a href="https://gallery.technet.microsoft.com/Gather-All-Lync-and-UM-dc15739a">technet gallery</a> or at my <a href="https://github.com/zloeber/Powershell/blob/master/Lync/Get-LyncAndUMInfo.ps1">new github repo</a>.</p>

<p>First ensure that the lync modules are loaded and available (I use -Verbose:$false throughout the script as I only want my own verbose output to be shown, not verbose output from every lync cmdlet that runs). &#8216;Break&#8217; is a nice way to simply exit the function. As it is very unlikely this function will be called in a non-standalone manner this kind of non-terminating non-error throwing exit is fine. I throw out a warning at least.</p>

<pre class="lang:powershell decode:true ">Import-Module Lync -ErrorAction:SilentlyContinue -Verbose:$false
if ((get-module lync) -eq $null)
{
Write-Warning "Get-LyncAndUMInfo: This script must be run on a lync server. Exiting!"
Break
}</pre>

<p>I also break out the properties I&#8217;m going to be snatching from users and contacts in AD. This is not at all necessary but it makes for easier script reading later on. Contacts and users are not the same so were I to try and use the user properties against a contact when querying AD I&#8217;d get errors.</p>

<pre class="lang:powershell decode:true ">$ADUserProperties = @('Name','GivenName','Surname','SamAccountName','mail','proxyAddresses','msRTCSIP-UserEnabled','msRTCSIP-Line','msExchUMEnabledFlags','msExchUMDtmfMap','msRTCSIP-PrimaryUserAddress')
$ADContactProperties = @('Name','GivenName','sn','mail','msRTCSIP-Line','msRTCSIP-PrimaryUserAddress')</pre>

<p>I then go ahead and query AD for users which are lync enabled. I use an old school LDAP filter because I&#8217;m an old school type of guy (well that and opath filters do not always have the nuanced properties available for me to filter against).</p>

<pre class="lang:powershell decode:true">Get-ADUser -Verbose:$false -LDAPFilter "(&(objectCategory=person)(objectClass=user)(msRTCSIP-UserEnabled=*))" -Properties $ADUserProperties | Where {($_.'msRTCSIP-UserEnabled' -ne $null) -and ($_.'msRTCSIP-UserEnabled' -ne $false)} | Foreach {</pre>

<p>If the user is Lync enabled then they also have a primary user address so I use that to gather even more information about the account. I have to do this in order to get the PIN information as that is not held in AD from what I could tell. In fact, if you remove the -Verbose:$false from the Get-CSClientPinInfo and run this whole function with the -Verbose parameter you will see the Lync cmdlet spit out primary frontend server names that are getting queried for PIN info.</p>

<pre class="lang:powershell decode:true">$LyncInfo = Get-CSUser -Verbose:$false $_.'msRTCSIP-PrimaryUserAddress' | Select SipAddress,EnterpriseVoiceEnabled,ExUmEnabled,DialPlan,VoicePolicy,PrivateLine, `
@{'n'='LyncPINSet';'e'={if ($_.EnterpriseVoiceEnabled){($_ | Get-CSClientPinInfo -Verbose:$false).IsPinSet} else {$false}}}</pre>

<p>At this point since I already have the Lync info I go ahead and use it to determine if the user is UM enabled or not. If it is UM enabled I look for any proxyAddress starting with eum: followed by some digits and that is very likely an extension for the voicemail for this user.</p>

<pre class="lang:powershell decode:true">if ($LyncInfo.ExUmEnabled)
{
$VoicemailExtension = $_.proxyAddresses | Where {$_ -match '^eum:(\d+).*$'} | Foreach {$Matches[1]}
}</pre>

<p>With the information we have collected I create another object and return it. I use a bit of regex trickery to extract the telephone number and extension from the full LYnc URI while I&#8217;m at it.</p>

<pre class="lang:powershell decode:true">$UserProps = @{
'Name' = $_.Name
'Type' = 'User'
'Enabled' = $_.Enabled
'FirstName' = $_.GivenName
'LastName' = $_.Surname
'Email' = $_.mail
'SipAddress' = $LyncInfo.SipAddress
'EnterpriseVoiceEnabled' = $LyncInfo.EnterpriseVoiceEnabled
'DialPlan' = $LyncInfo.DialPlan
'VoicePolicy' = $LyncInfo.VoicePolicy
'LyncPinSet' = $LyncInfo.LyncPinSet
'LyncTelURI' = $_.'msRTCSIP-Line'
'LyncPrivateLine' = $LyncInfo.PrivateLine
'LyncPhone' = if ($_.'msRTCSIP-Line' -match '^tel:(\+\d+).*$'){$matches[1]} else {$null}
'LyncPhoneExt' = if ($_.'msRTCSIP-Line' -match '^.*ext=(.*)$'){$matches[1]} else {$null}
'VoicemailEnabled' = $LyncInfo.ExUmEnabled
'VoicemailExtension' = $VoicemailExtension
}
New-Object PSObject -Property $UserProps</pre>

<p>As it is very possible to have enterprise voice enabled contacts (that is all an autoattendant is in AD) we should probably get that information as well. I use Get-ADObject with another ldap filter to only look for contacts which are lync enabled.</p>

<pre class="lang:powershell decode:true ">Â  Â  Â  Get-ADObject -Verbose:$false -LDAPFilter "(&(objectCategory=person)(objectClass=contact)(msRTCSIP-Line=*))" -Properties $ADContactProperties | Foreach {</pre>

<p>I then return everything pretty much the same way as I did for user accounts except skip the voicemail and pin checking (though now that I&#8217;m writing this and thinking about it a pin check against enterprise voice enabled contacts may not be a bad idea&#8230;.).</p>

<pre class="lang:powershell decode:true ">$UserProps = @{
'Name' = $_.Name
'Type' = 'Contact'
'Enabled' = $null
'FirstName' = $_.GivenName
'LastName' = $_.sn
'Email' = $_.mail
'SipAddress' = $_.'msRTCSIP-PrimaryUserAddress'
'EnterpriseVoiceEnabled' = $null
'DialPlan' = $null
'VoicePolicy' = $null
'LyncPinSet' = $null
'LyncTelURI' = $_.'msRTCSIP-Line'
'LyncPrivateLine' = $null
'LyncPhone' = if ($_.'msRTCSIP-Line' -match '^tel:(\+\d+).*$'){$matches[1]} else {$null}
'LyncPhoneExt' = if ($_.'msRTCSIP-Line' -match '^.*ext=(.*)$'){$matches[1]} else {$null}
'VoicemailEnabled' = $null
'VoicemailExtension' = $null
}
New-Object PSObject -Property $UserProps</pre>

<p>With this function you can now create and export reports with some interesting information that may help in your deployment. Here are a few examples.</p>

<pre class="lang:powershell decode:true ">$Users = Get-LyncAndUMInfo
$Users | Export-Csv AllLyncEnabledUserInfo.csv -NoTypeInformation
$Users | where {(-not $_.Enabled) -and $_.EnterpriseVoiceEnabled} | Export-Csv DisabledWithLyncNumbersStillAssigned.csv -NoTypeInformation
$Users | where {$_.Enabled -and $_.EnterpriseVoiceEnabled -and (-not $_.LyncPinSet)} | Export-Csv EnabledWithLyncNumbersAssignedButNoPINSet.csv -NoTypeInformation
$Users | where {$_.Enabled -and $_.EnterpriseVoiceEnabled -and (-not $_.VoicemailEnabled)} | Export-Csv EnabledWithLyncNumbersAssignedButNoVoicemailConfigured.csv -NoTypeInformation</pre>

<p>As always, I welcome feedback and improvements. You can download the function in its entirety from theÂ <a href="https://gallery.technet.microsoft.com/Gather-All-Lync-and-UM-dc15739a">technet gallery</a> or at my <a href="https://github.com/zloeber/Powershell/blob/master/Lync/Get-LyncAndUMInfo.ps1">new github repo</a>.</p>

<p>&nbsp;</p>

    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="/tags/exchange">Exchange</a>
                
                    <a href="/tags/exchange-2010">Exchange 2010</a>
                
                    <a href="/tags/exchange-2013">Exchange 2013</a>
                
                    <a href="/tags/lync">Lync</a>
                
                    <a href="/tags/lync-2010">Lync 2010</a>
                
                    <a href="/tags/lync-2013">Lync 2013</a>
                
                    <a href="/tags/powershell">Powershell</a>
                
                    <a href="/tags/sysadmin">Sysadmin</a>
                
                    <a href="/tags/system-administration">System Administration</a>
                
                    <a href="/tags/windows">Windows</a>
                
            </div>
        </div>
    

    
</div>

</article>

        
    </div>

    
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "zacharyloeber-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

     

        </div>

        
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong>Latest posts</strong>
                <ul>
                
                    <li>
                        <a href="/blog/2018/12/10/devops-tool-of-the-day-syncthing/">Devops: Tool of the day â Syncthing</a>
                    </li>
                
                    <li>
                        <a href="/blog/2018/09/28/devops-automating-kubernetes-deployments/">DevOps â Automating Kubernetes Deployments</a>
                    </li>
                
                    <li>
                        <a href="/blog/2018/05/02/powershell-to-python-notes-from-the-field/">Powershell To Python Notes From The Field</a>
                    </li>
                
                </ul>
        </div>
        

        
        <div class="categories">
            <a href="/categories/"><strong>Categories</strong></a>
                <ul>
                
                    <li>
                        <a href="/categories/system-administration">System administration (130)</a>
                    </li>
                
                    <li>
                        <a href="/categories/microsoft">Microsoft (120)</a>
                    </li>
                
                    <li>
                        <a href="/categories/powershell">Powershell (106)</a>
                    </li>
                
                    <li>
                        <a href="/categories/networking">Networking (52)</a>
                    </li>
                
                    <li>
                        <a href="/categories/active-directory">Active directory (44)</a>
                    </li>
                
            </ul>
        </div>
        

        <div class="right">
            
            <div class="external-profiles">
                <strong>Social media</strong>

                
                
                    <a href="https://twitter.com/zloeber" target="_blank"><i class="fa fa-twitter-adblock-proof"></i></a>
                
                
                
                
                
                
                
                
                
                    <a href="https://github.com/zloeber" target="_blank"><i class="fa fa-github"></i></a>
                
                
            </div>
            

            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://github.com/zloeber" target="_blank">
                &copy;
                
                    2019
                
                by Zachary Loeber
            </a>
	    
        </div>
        <div class="author">
            <a href="https://github.com/Lednerb/bilberry-hugo-theme" target="_blank">Bilberry Hugo Theme</a>
        </div>
    </div>
</div>


        

        

        
        
        <script type="text/javascript" src="/js/externalDependencies.39c47e10e241eae2947b3fe21809c572.js" integrity="md5-OcR&#43;EOJB6uKUez/iGAnFcg=="></script>

        
        
        <script type="text/javascript" src="/js/theme.ff50ae6dc1bfc220b23bf69dbb41b54e.js" integrity="md5-/1CubcG/wiCyO/adu0G1Tg=="></script>

        <script>
            $(".moment").each(function() {
                $(this).text(
                    moment( $(this).text() )
                        .locale( "en" )
                        .format('LL')
                );
            });

            $(".footnote-return sup").html("");
        </script>

        
            
        

        


    </body>
</html>
