<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Zachary Loeber">
        <meta name="description" content="Zachary Loeber&#39;s Personal Site">
        <meta name="keywords" content="blog,personal,devops,infrastructure,code">
        <meta name="generator" content="Hugo 0.53" />
        <title> Powershell: Check For Misplaced Certificates | Zachary Loeber</title>
        <meta name="description" content="Powershell: Check For Misplaced Certificates - Zachary Loeber&#39;s Personal Site">
        <meta itemprop="name" content="Powershell: Check For Misplaced Certificates">
        <meta itemprop="description" content="Powershell: Check For Misplaced Certificates - Zachary Loeber&#39;s Personal Site">
        <meta property="og:title" content="Powershell: Check For Misplaced Certificates">
        <meta property="og:description" content="Powershell: Check For Misplaced Certificates - Zachary Loeber&#39;s Personal Site">
        <meta property="og:image" content="https://www.gravatar.com/avatar/48fc6231ab6cad25f101a82e5932d9dd?size=200">
        <meta property="og:url" content="http://zacharyloeber.com/blog/2014/12/10/powershell-check-for-misplaced-certificates/">
        <meta property="og:site_name" content="Zachary Loeber">
        <meta property="og:type" content="article">
        <link rel="icon" type="image/png" href="http://zacharyloeber.com/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="http://zacharyloeber.com/favicon-16x16.png" sizes="16x16">

	

        
        
        
        
        <link rel="stylesheet" href="/sass/combined.min.5aca3dc995ccd40fd537c60ccb5ce5882145ec5d4c4827c15f277667981cc0de.css">

        

        
            
        
    </head>
    <body class="bilberry-hugo-theme">
        
<nav class="permanentTopNav">

    <div class="container">
        <ul class="topnav">
            
                
                    <li><a href="https://github.com/zloeber" target="_blank">Github</a></li>
                
            
                
                    <li><a href="/page/about/">About</a></li>
                
            
                
                    <li><a href="/page/about-me/">About Me</a></li>
                
            
        </ul>

        
    </div>
</nav>


        <header>
    <div class="container">
        <div class="logo">
            <a href="/" class="logo">
                
                    <img src="https://www.gravatar.com/avatar/48fc6231ab6cad25f101a82e5932d9dd?d=mm&size=200" alt="">
                

                <span class="overlay"><i class="fa fa-home"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title"><a href="/">Zachary Loeber</a></h3>
            
                <span class="subtitle">The personal website of Zachary Loeber.</span>
            
        </div>

    

        
        <div class="toggler permanentTopNav">
        
            <i class="fa fa-bars" aria-hidden="true"></i>
        </div>
    </div>
</header>


        <div class="main container">
            
     
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="/blog/2014/12/10/powershell-check-for-misplaced-certificates/">
    <i class="fa fa-fw fa-pencil"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h3><a href="/blog/2014/12/10/powershell-check-for-misplaced-certificates/">Powershell: Check For Misplaced Certificates</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2014-12-11</span>
            
        

        
            <span class="readingTime">4 min read</span>
        

        
            <span class="categories">
                
                    <a href="/categories/exchange-2013">Exchange 2013</a>
                
                    <a href="/categories/lync">Lync</a>
                
                    <a href="/categories/microsoft">Microsoft</a>
                
                    <a href="/categories/powershell">Powershell</a>
                
                    <a href="/categories/security">Security</a>
                
                    <a href="/categories/system-administration">System Administration</a>
                
            </span>
        

        
            <span class="author"><a href="/author/zachary-loeber">Zachary Loeber</a></span>
        
    </div>

    
        <p>Here is a script I absentmindedly put together one evening while power watching a TV series on Netflix with the wife. The general idea of this script is to check local machine, trusted root, and intermediate trusted root stores for misplaced or duplicate certificates.</p>

<p>It is easy to get lax when deploying or maintaining Windows servers that require any kind of certificates to be installed. You may end up with trusted root certificates (aka self-signed issuing certs) in your intermediate trust store or vice versa. You may also have duplicated public certs across stores for whatever reason. Prior to Server 2012 and some of the more modern applications this really wasn’t an issue. As of late I’ve experiences some Lync 2013 oddities that make me think that it is about time to be more diligent with certificate placement and this script will help towards this end.</p>

<p>Anyway, the script makes educated guesses on incorrect cert placements and provides advice on what actions to take.</p>

<pre class="lang:powershell decode:true "># Checks for possibly misplaced or duplicated certs
#
# *Check Trusted Root Store
# First get all trusted root certs in store
$rootcerts = Get-Childitem 'cert:\LocalMachine\root' -Recurse
# Check for certs which were not their own issuer (thus not a root certificate!)
$misplacedrootcerts = $rootcerts | Where-Object {$_.Issuer -ne $_.Subject}
Foreach ($cert in $misplacedrootcerts) {
    if (($intermediatecerts).thumbprint -contains $cert.thumbprint) {
        Write-Host -ForegroundColor:Yellow "Intermediate cert found duplicated in root cert store - $($cert.Subject)"
        Write-Host -ForegroundColor:Magenta "Recommended action: Delete certificate from trusted root store."
        Write-Host -ForegroundColor:DarkMagenta '**Certificate Details **'
        Write-Host $cert
        Read-Host -Prompt ''
    }
    else {
        Write-Host -ForegroundColor:Yellow "Intermediate cert found in root cert store - $($cert.Subject)"
        Write-Host -ForegroundColor:Magenta "Recommended action: Move certificate from trusted root store to intermediate store."
        Write-Host -ForegroundColor:DarkMagenta '**Certificate Details **'
        Write-Host $cert
        Read-Host -Prompt ''
    }
}

# *Check Trusted Intermediate Store
# First get all trusted intermediate certs in store
$intermediatecerts = Get-Childitem 'cert:\LocalMachine\CA' -Recurse | Where {$_.Subject -ne 'CN=Root Agency'}
# Check for certs which issued themselves (thus not an intermediate certificate!)
$misplacedintermediatecerts = $intermediatecerts | Where-Object {$_.Issuer -eq $_.Subject}
Foreach ($cert in $misplacedintermediatecerts) {
    if (($rootcerts).thumbprint -contains $cert.thumbprint) {
        Write-Host -ForegroundColor:Yellow "Trusted root cert found duplicated in intermediate cert store - $($cert.Subject)"
        Write-Host -ForegroundColor:Magenta "Recommended action: Delete certificate from intermediate store."
        Write-Host -ForegroundColor:DarkMagenta '**Certificate Details **'
        Write-Host $cert
        Read-Host -Prompt ''
    }
    else {
        Write-Host -ForegroundColor:Yellow "Trusted root cert found in intermediate cert store - $($cert.Subject)"
        Write-Host -ForegroundColor:Magenta "Recommended action: Move certificate from intermediate cert store to root cert store."
        Write-Host -ForegroundColor:DarkMagenta '**Certificate Details **'
        Write-Host $cert
        Read-Host -Prompt ''
    }
}

# *Check Local machine store
# First get all local machine certs in store
$mycerts = Get-Childitem 'cert:\LocalMachine\My' -Recurse
$myselfsignedcerts = $mycerts | Where-Object {$_.Issuer -eq $_.Subject}
$myrootduplicatedcerts = $mycerts | Where-Object {($rootcerts).thumbprint -contains $_.thumbprint}
$myintermediateduplicatedcerts = $mycerts | Where-Object {($intermediatecerts).thumbprint -contains $_.thumbprint}

Foreach ($cert in $myrootduplicatedcerts) {
    if (($myselfsignedcerts).thumbprint -contains $cert.thumbprint) {
        Write-Host -ForegroundColor:Yellow "Local machine certificate found duplicated in trusted root cert store - $($cert.Subject)"
        Write-Host -ForegroundColor:Yellow "Certificate status: SELF-SIGNED (Possible trusted root authority)"
        Write-Host -ForegroundColor:Magenta "Recommended action: Validate if the cert is a trusted root or simply self-signed and remove duplicate from one of the stores."
        Write-Host -ForegroundColor:DarkMagenta '**Certificate Details **'
        Write-Host $cert
        Read-Host -Prompt ''
    }
    else {
        Write-Host -ForegroundColor:Yellow "Local machine certificate found duplicated in trusted root cert store - $($cert.Subject)"
        Write-Host -ForegroundColor:Yellow "Certificate status: NOT SELF-SIGNED (Not a possible trusted root authority)"
        Write-Host -ForegroundColor:Magenta "Recommended action: Delete this certificate from the trusted root store."
        Write-Host -ForegroundColor:DarkMagenta '**Certificate Details **'
        Write-Host $cert
        Read-Host -Prompt ''
    }
}

Foreach ($cert in $myintermediateduplicatedcerts) {
    if (($myselfsignedcerts).thumbprint -contains $cert.thumbprint) {
        Write-Host -ForegroundColor:Yellow "Local machine certificate found duplicated in intermediate root cert store - $($cert.Subject)"
        Write-Host -ForegroundColor:Yellow "Certificate status: SELF-SIGNED (Possible trusted root authority)"
        Write-Host -ForegroundColor:Magenta "Recommended action: Delete this certificate from the intermediate root store. Possibly move it to the trusted root store."
        Write-Host -ForegroundColor:DarkMagenta '**Certificate Details **'
        Write-Host $cert
        Read-Host -Prompt ''
    }
    else {
        Write-Host -ForegroundColor:Yellow "Local machine certificate found duplicated in trusted root cert store - $($cert.Subject)"
        Write-Host -ForegroundColor:Yellow "Certificate status: NOT SELF-SIGNED (Not a possible trusted root authority)"
        Write-Host -ForegroundColor:Magenta "Recommended action: Validate if the cert is an intermediate root or a valid local machine cert and remove the duplicate from one of the stores."
        Write-Host -ForegroundColor:DarkMagenta '**Certificate Details **'
        Write-Host $cert
        Read-Host -Prompt ''
    }
}</pre>

<p>&nbsp;</p>
    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="/tags/exchange-2013">Exchange 2013</a>
                
                    <a href="/tags/lync-2013">Lync 2013</a>
                
                    <a href="/tags/microsoft">Microsoft</a>
                
                    <a href="/tags/powershell">Powershell</a>
                
                    <a href="/tags/psc">PSC</a>
                
                    <a href="/tags/scripting">Scripting</a>
                
                    <a href="/tags/security">Security</a>
                
                    <a href="/tags/sysadmin">Sysadmin</a>
                
                    <a href="/tags/system-administration">System Administration</a>
                
            </div>
        </div>
    

    
</div>

</article>

        
    </div>

    
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "zacharyloeber-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

     

        </div>

        
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong>Latest posts</strong>
                <ul>
                
                    <li>
                        <a href="/blog/2018/12/10/devops-tool-of-the-day-syncthing/">Devops: Tool of the day – Syncthing</a>
                    </li>
                
                    <li>
                        <a href="/blog/2018/09/28/devops-automating-kubernetes-deployments/">DevOps – Automating Kubernetes Deployments</a>
                    </li>
                
                    <li>
                        <a href="/blog/2018/05/02/powershell-to-python-notes-from-the-field/">Powershell To Python Notes From The Field</a>
                    </li>
                
                </ul>
        </div>
        

        
        <div class="categories">
            <a href="/categories/"><strong>Categories</strong></a>
                <ul>
                
                    <li>
                        <a href="/categories/system-administration">System administration (130)</a>
                    </li>
                
                    <li>
                        <a href="/categories/microsoft">Microsoft (120)</a>
                    </li>
                
                    <li>
                        <a href="/categories/powershell">Powershell (106)</a>
                    </li>
                
                    <li>
                        <a href="/categories/networking">Networking (52)</a>
                    </li>
                
                    <li>
                        <a href="/categories/active-directory">Active directory (44)</a>
                    </li>
                
            </ul>
        </div>
        

        <div class="right">
            
            <div class="external-profiles">
                <strong>Social media</strong>

                
                
                    <a href="https://twitter.com/zloeber" target="_blank"><i class="fa fa-twitter-adblock-proof"></i></a>
                
                
                
                
                
                
                
                
                
                    <a href="https://github.com/zloeber" target="_blank"><i class="fa fa-github"></i></a>
                
                
            </div>
            

            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://github.com/zloeber" target="_blank">
                &copy;
                
                    2019
                
                by Zachary Loeber
            </a>
	    
        </div>
        <div class="author">
            <a href="https://github.com/Lednerb/bilberry-hugo-theme" target="_blank">Bilberry Hugo Theme</a>
        </div>
    </div>
</div>


        

        

        
        
        <script type="text/javascript" src="/js/externalDependencies.39c47e10e241eae2947b3fe21809c572.js" integrity="md5-OcR&#43;EOJB6uKUez/iGAnFcg=="></script>

        
        
        <script type="text/javascript" src="/js/theme.ff50ae6dc1bfc220b23bf69dbb41b54e.js" integrity="md5-/1CubcG/wiCyO/adu0G1Tg=="></script>

        <script>
            $(".moment").each(function() {
                $(this).text(
                    moment( $(this).text() )
                        .locale( "en" )
                        .format('LL')
                );
            });

            $(".footnote-return sup").html("");
        </script>

        
            
        

        


    </body>
</html>
