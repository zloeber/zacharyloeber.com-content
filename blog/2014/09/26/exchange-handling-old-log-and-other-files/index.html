<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Zachary Loeber">
        <meta name="description" content="Zachary Loeber&#39;s Personal Site">
        <meta name="keywords" content="blog,personal,devops,infrastructure,code">
        <meta name="generator" content="Hugo 0.53" />
        <title> Exchange: Handling Old Log and Other Files | Zachary Loeber</title>
        <meta name="description" content="Exchange: Handling Old Log and Other Files - Zachary Loeber&#39;s Personal Site">
        <meta itemprop="name" content="Exchange: Handling Old Log and Other Files">
        <meta itemprop="description" content="Exchange: Handling Old Log and Other Files - Zachary Loeber&#39;s Personal Site">
        <meta property="og:title" content="Exchange: Handling Old Log and Other Files">
        <meta property="og:description" content="Exchange: Handling Old Log and Other Files - Zachary Loeber&#39;s Personal Site">
        <meta property="og:image" content="https://www.gravatar.com/avatar/48fc6231ab6cad25f101a82e5932d9dd?size=200">
        <meta property="og:url" content="https://zacharyloeber.com/blog/2014/09/26/exchange-handling-old-log-and-other-files/">
        <meta property="og:site_name" content="Zachary Loeber">
        <meta property="og:type" content="article">
        <link rel="icon" type="image/png" href="https://zacharyloeber.com/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://zacharyloeber.com/favicon-16x16.png" sizes="16x16">

	

        
        
        
        
        <link rel="stylesheet" href="/sass/combined.min.5aca3dc995ccd40fd537c60ccb5ce5882145ec5d4c4827c15f277667981cc0de.css">

        

        
            
        
    </head>
    <body class="bilberry-hugo-theme">
        
<nav class="permanentTopNav">

    <div class="container">
        <ul class="topnav">
            
                
                    <li><a href="https://github.com/zloeber" target="_blank">Github</a></li>
                
            
                
                    <li><a href="/page/about/">About</a></li>
                
            
                
                    <li><a href="/page/about-me/">About Me</a></li>
                
            
        </ul>

        
    </div>
</nav>


        <header>
    <div class="container">
        <div class="logo">
            <a href="/" class="logo">
                
                    <img src="https://www.gravatar.com/avatar/48fc6231ab6cad25f101a82e5932d9dd?d=mm&size=200" alt="">
                

                <span class="overlay"><i class="fa favicon-32x32.png"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title"><a href="/">Zachary Loeber</a></h3>
            
                <span class="subtitle">The personal website of Zachary Loeber.</span>
            
        </div>

    

        
        <div class="toggler permanentTopNav">
        
            <i class="fa fa-bars" aria-hidden="true"></i>
        </div>
    </div>
</header>


        <div class="main container">
            
     
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="/blog/2014/09/26/exchange-handling-old-log-and-other-files/">
    <i class="fa fa-fw fa-pencil"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h3><a href="/blog/2014/09/26/exchange-handling-old-log-and-other-files/">Exchange: Handling Old Log and Other Files</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2014-09-26</span>
            
        

        
            <span class="readingTime">7 min read</span>
        

        
            <span class="categories">
                
                    <a href="/categories/exchange">Exchange</a>
                
                    <a href="/categories/exchange-2010">Exchange 2010</a>
                
                    <a href="/categories/exchange-2013">Exchange 2013</a>
                
                    <a href="/categories/iis">IIS</a>
                
                    <a href="/categories/microsoft">Microsoft</a>
                
                    <a href="/categories/powershell">Powershell</a>
                
                    <a href="/categories/system-administration">System Administration</a>
                
            </span>
        

        
            <span class="author"><a href="/author/zachary-loeber">Zachary Loeber</a></span>
        
    </div>

    
        

<p>In Exchange old logs can really build up fast. Not database transaction logs but rather temporary transport, client access, IIS, and other debug related crap that typically default to locations either on your system drive or Exchange install path. Of course, Powershell scripting can provide a decent solution for this problem.</p>

<h2 id="introduction">Introduction</h2>

<p>More than any other version, Exchange 2013 seems to like logging information to disk. By default, much of what gets logged will not auto-rotate (or if it does, it happens infrequently) either so you end up with this slow ticking time-bomb in your environment.</p>

<p>I’ve been using a few one liners for a while now to pare down old logs and such from Exchange 2013 servers. In a pinch this still works just fine:</p>

<pre class="lang:powershell decode:true">$TransportTemp = "$($env:ExchangeInstallPath)TransportRoles\Data\Temp" 
$ExchangeLogging = "$($env:ExchangeInstallPath)Logging" 
Get-ChildItem $TransportTemp | gci -Recurse | ? LastWriteTime -lt (Get-Date).AddDays(-14) | Remove-Item 
Get-ChildItem 'C:\inetpub\logs',$ExchangeLogging -Directory | gci -Include '*.log','*.blg' -Recurse | ? LastWriteTime -lt (Get-Date).AddDays(-14) | Remove-Item</pre>

<p>The down side to this quick approach is that you have to run this directly on each server and there is no real reporting on how much space you are saving. It also requires knowing where some of the logs are ahead of time (c:\inetpub). Finally, this only gets a small subset of the logs most likely to balloon out of control.</p>

<p>In any case it is all very manual and is just a quick hack. So I finally decided to put an official script together instead. And, as I tend to do with scripts, I probably over-engineered the solution. But it works for me and may be valuable to you even if you are not explicitly using it for Exchange.</p>

<h2 id="interesting-script-notes">Interesting Script Notes</h2>

<p>One of the issues with existing scripts for cleaning out exchange logs is that they are based around the files being located in the same locations on every server. I get around this with some psremoting (invoke-command) to gather web logging locations and exchange install paths.</p>

<blockquote>
<p>Note: Enable remoting with the following in a cmd prompt:</p>

<p>winrm quickconfig</p>
</blockquote>

<p>Since I’m already using psremoting to get log file locations I also use it again for some of the folder size reporting to get some performance boosts. (Remotely enumerating several hundred files can take a very long time in powershell but you can get around this with Scripting.FileSystemObject run locally on a system). This only makes sense if you are looking for entire folder size information. If you are filtering folders by file type or date for utilization there is no real choice but to use builtin powershell looping.</p>

<p>Here is the function I put together for getting the folder size with all of these factors. I added in some logic at the very beginning to determine if the path is local or remote as well.</p>

<pre class="lang:powershell decode:true">function Get-FolderSize {
    [CmdletBinding()]
    param (
        [Parameter(Mandatory=$true, HelpMessage='Directory path')]
        [string]$path,
        [Parameter(HelpMessage='Only include data older than this number of days in calculation. Ignored if set to zero.')]
        [int]$days = 0,
        [Parameter(HelpMessage='Only include files matching this criteria.')]
        [string[]]$criteria = '*',
        [string]$ComputerName,
        [switch]$UseRemoting,
        [System.Management.Automation.Runspaces.PSSession]$Session = $null

    )
    $InvokeSplat = @{}

    $LocalPath = $false
    if ($path -like '*:*')
    {
        $LocalPath = $true
    }
    elseif ($path -like '\\*')
    {
        if ($path -match '\\\\(.*?)\\')
        {
            $ComputerName = $Matches[1]
        }
        else
        {
            throw 'Get-FolderSize: Invalid Path!'
        }

        $IPAddresses = [net.dns]::GetHostAddresses($env:COMPUTERNAME) | Select-Object -ExpandProperty IpAddressToString
        $HostNames = $IPAddresses | ForEach-Object {
            try {
                [net.dns]::GetHostByAddress($_)
            } 
            catch {}
        } | Select-Object -ExpandProperty HostName -Unique
        $LocalHost = @('', '.', 'localhost', $env:COMPUTERNAME, '::1', '127.0.0.1') + $IPAddresses + $HostNames
        if ($LocalHost -contains $ComputerName)
        {
            $LocalPath = $true
        }
    }
    
    if (Test-Path $path)
    {
        if (($LocalPath -or $UseRemoting) -and (($days -eq 0) -and ($criteria -eq '*')))
        {   # using fso (faster)
            # convert to local pathname first
            $path = $path -replace '\$',':' -replace '(^\\\\.*?\\)',''
            if ($UseRemoting)
            {
                if ($Session -ne $null)
                {
                    $InvokeSplat.Session = $Session
                }
                else
                {
                    $InvokeSplat.ComputerName = $ComputerName
                }
                Write-Verbose "Get-FolderSize: Using remoting with FileSystemObject on $ComputerName to enumerate $path..."
                $RemoteCMDString = "`$objFSO = New-Object -com  Scripting.FileSystemObject; `$objFSO.GetFolder(`'$path`').Size"
                $RemoteCMD = [scriptblock]::Create($RemoteCMDString)
                return $(Invoke-Command @InvokeSplat -ScriptBlock $RemoteCMD)
            }
            else
            {
                Write-Verbose "Get-FolderSize: Using FileSystemObject on localhost to enumerate $path..."
                $objFSO = New-Object -com  Scripting.FileSystemObject
                return $objFSO.GetFolder($path).Size
            }
        }
        else
        {
            # pure powershell (slower)
            Write-Verbose "Get-FolderSize: Using powershell to enumerate $path..."
            $LastWrite = (Get-Date).AddDays(-$days)
            $colItems = (Get-ChildItem -Recurse $path -Include $criteria -ErrorAction:SilentlyContinue | 
                            Where {$_.LastWriteTime -le "$LastWrite"} | 
                                Measure-Object -property length -sum)
            return $colItems.sum
        }
    }
    else
    {
        Write-Warning 'Get-FolderSize: Invalid Path!'
    }
}</pre>

<p>I’ve wrapped up a number of additional functions with this folder size function in a single script with some predefined scenarios to make the script easier to use. The scenarios included are:</p>

<blockquote>
<p><span style="text-decoration: underline;">RetrieveValidFolders</span> – Gather a list of valid Exchange logging and temp folders which you can use to pipe into other functions to perform custom actions.</p>

<p><span style="text-decoration: underline;">ReportOldLogSize</span> &#8211; Gather a list of valid Exchange logging and temp folders and also enumerate their total size as well as the size of all the old logs that exist before the specified number of days. This includes message tracking logs.</p>

<p><span style="text-decoration: underline;">DeleteOldLogs</span> – Attempt to delete all logs which are older than the number of days specified. This does NOT include message tracking logs.</p>

<p><span style="text-decoration: underline;">DeleteOldLogsTestRun</span> – Same as DeleteOldLogs but without actually deleting anything (adds –WhatIf to all Remove-Item commands). This does NOT include message tracking logs.</p>
</blockquote>

<p>These scenarios work in concert with the available parameters to give you more control of which servers will be targeted and how many days worth of logs you want to keep.</p>

<blockquote>
<p><span style="text-decoration: underline;">DaysToKeep</span> – The number of days of log files you wish to retain.</p>

<p><span style="text-decoration: underline;">ServerFilter</span> – Target specific Exchange 2013 servers. By default all (*) servers in the environment are targeted.</p>

<p><span style="text-decoration: underline;">FileTypes</span> &#8211; The types of old files to report upon or delete. By default this is *.log and *.blg. You may want to manually set this to * instead to force psremoting and fast directory size enumeration.</p>
</blockquote>

<p>It should be noted that I&#8217;m not even trying to rotate or save the old files with this script. This is was written to report upon and optionally delete old logs and other temporary files related to Exchange 2013. Obviously take care with what you delete in your own environment.</p>

<p>The default file types which will be reported upon or cleaned up are *.log and *.blg (daily performance counter files). Optionally you may want to include *.bak to get some of the perfmon counter load backup files as well.</p>

<h2 id="examples">Examples</h2>

<p>Here is a report of logs older than 14 days. Note that the message tracking logs are included here but are not part of the actual deletion scenarios unless you make manual modifications (add in your own scenario).</p>

<pre class="lang:powershell decode:true">$oldlogs = .\Manage-ExchangeDirectories.ps1 -DaysToKeep 14 -Scenario:ReportOldLogSize -Verbose 
$oldlogs | ft -auto</pre>

<p><a href="wp-content/uploads/2014/09/image.png"><img style="margin: 5px; display: inline; background-image: none;" title="image" src="/wp-content/uploads/2014/09/image_thumb.png?resize=551%2C234" alt="image" width="551" height="234" border="0" data-recalc-dims="1" /></a></p>

<p>Here is a more complicated example which targets one specific server. The following lines will gather only total folder size information via psremoting (thus speeding up processing time) first. We then delete any *.log, *.blg, and *.bak files older than 14 days. Finally we generate a report on the folders previous vs. its current size. Again notice that I don&#8217;t futz with message tracking at all. But since it is included in the report aspect of this script the folder for message tracking actually goes up in size!</p>

<pre class="lang:powershell decode:true">$logdirsize = .\Manage-ExchangeDirectories.ps1 -DaysToKeep 0 -FileTypes '*' -Scenario:ReportOldLogSize -ServerFilter 'EXCH2' -Verbose
.\Manage-ExchangeDirectories.ps1 -Scenario:DeleteOldLogs -DaysToKeep 14 -ServerFilter 'EXCH2' -Verbose -FileTypes '*.log','*.blg','*.bak'
$newlogdirsize = .\Manage-ExchangeDirectories.ps1 -DaysToKeep 0 -FileTypes '*' -Scenario:ReportOldLogSize -ServerFilter 'EXCH2' -Verbose
$logdirsize | %{ $logdir = $_; $newlogdir = $newlogdirsize | where {$_.Description -eq $logdir.description}; New-Object psobject -Property @{'Log' = $logdir.Description;'OldSize' = $logdir.TotalSize;'NewSize' = $newlogdir.Totalsize}}|Select log,Oldsize,Newsize | ft -auto</pre>

<p><a href="/wp-content/uploads/2014/09/SizeDiffReport.jpg"><img class="aligncenter size-medium wp-image-1274" src="/wp-content/uploads/2014/09/SizeDiffReport.jpg?resize=300%2C90" alt="SizeDiffReport" width="300" height="90" srcset="/wp-content/uploads/2014/09/SizeDiffReport.jpg?resize=300%2C90 300w, /wp-content/uploads/2014/09/SizeDiffReport.jpg?w=529 529w" sizes="(max-width: 300px) 100vw, 300px" data-recalc-dims="1" /></a></p>

<h2 id="conclusion">Conclusion</h2>

<p>This should be a pretty easy script to schedule via task scheduler if you so desired. To <a href="http://gallery.technet.microsoft.com/Exchange-Manage-Log-36ced742">download the script in its entirety visit the technet gallery.</a></p>

    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="/tags/exchange-2010">Exchange 2010</a>
                
                    <a href="/tags/exchange-2013">Exchange 2013</a>
                
                    <a href="/tags/powershell">Powershell</a>
                
                    <a href="/tags/psc">PSC</a>
                
                    <a href="/tags/sysadmin">Sysadmin</a>
                
                    <a href="/tags/system-administration">System Administration</a>
                
            </div>
        </div>
    

    
</div>

</article>

        
    </div>

    
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "zacharyloeber-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

     

        </div>

        
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong>Latest posts</strong>
                <ul>
                
                    <li>
                        <a href="/blog/2018/12/10/devops-tool-of-the-day-syncthing/">Devops: Tool of the day – Syncthing</a>
                    </li>
                
                    <li>
                        <a href="/blog/2018/09/28/devops-automating-kubernetes-deployments/">DevOps – Automating Kubernetes Deployments</a>
                    </li>
                
                    <li>
                        <a href="/blog/2018/05/02/powershell-to-python-notes-from-the-field/">Powershell To Python Notes From The Field</a>
                    </li>
                
                </ul>
        </div>
        

        
        <div class="categories">
            <a href="/categories/"><strong>Categories</strong></a>
                <ul>
                
                    <li>
                        <a href="/categories/system-administration">System administration (130)</a>
                    </li>
                
                    <li>
                        <a href="/categories/microsoft">Microsoft (120)</a>
                    </li>
                
                    <li>
                        <a href="/categories/powershell">Powershell (106)</a>
                    </li>
                
                    <li>
                        <a href="/categories/networking">Networking (52)</a>
                    </li>
                
                    <li>
                        <a href="/categories/active-directory">Active directory (44)</a>
                    </li>
                
            </ul>
        </div>
        

        <div class="right">
            
            <div class="external-profiles">
                <strong>Social media</strong>

                
                
                    <a href="https://twitter.com/zloeber" target="_blank"><i class="fa fa-twitter-adblock-proof"></i></a>
                
                
                
                
                
                
                
                
                
                    <a href="https://github.com/zloeber" target="_blank"><i class="fa fa-github"></i></a>
                
                
            </div>
            

            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://github.com/zloeber" target="_blank">
                &copy;
                
                    2019
                
                by Zachary Loeber
            </a>
	    
        </div>
        <div class="author">
            <a href="https://github.com/Lednerb/bilberry-hugo-theme" target="_blank">Bilberry Hugo Theme</a>
        </div>
    </div>
</div>


        

        

        
        
        <script type="text/javascript" src="/js/externalDependencies.39c47e10e241eae2947b3fe21809c572.js" integrity="md5-OcR&#43;EOJB6uKUez/iGAnFcg=="></script>

        
        
        <script type="text/javascript" src="/js/theme.ff50ae6dc1bfc220b23bf69dbb41b54e.js" integrity="md5-/1CubcG/wiCyO/adu0G1Tg=="></script>

        <script>
            $(".moment").each(function() {
                $(this).text(
                    moment( $(this).text() )
                        .locale( "en" )
                        .format('LL')
                );
            });

            $(".footnote-return sup").html("");
        </script>

        
            
        

        


    </body>
</html>
